name: Format Check (shfmt)

on:
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  format-check:
    name: Check shell script formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shfmt
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y shfmt

      - name: Find shell files
        id: find_files
        run: |
          set -euo pipefail
          files=$(git ls-files -- "dcvm" "*.sh" || true)
          {
            echo 'files<<EOF'
            echo "$files"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Check formatting (shfmt -d)
        run: |
          set -euo pipefail
          files="${{ steps.find_files.outputs.files }}"
          if [[ -z "$files" ]]; then
            echo "No shell files to check"
            exit 0
          fi
          
          has_errors=false
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            if [[ -f "$file" ]]; then
              echo "Checking $file..."
              if ! shfmt -d -i 2 "$file"; then
                has_errors=true
              fi
            fi
          done <<< "$files"
          
          if [[ "$has_errors" == "true" ]]; then
            echo ""
            echo "::error::Formatting issues found. Please run 'shfmt -w -i 2' on the files above."
            echo ""
            echo "Quick fix:"
            echo "  shfmt -w -i 2 dcvm lib/**/*.sh"
            exit 1
          fi
          
          echo "All files are properly formatted!"
